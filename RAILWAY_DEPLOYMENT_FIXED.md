# Railway Deployment - Fixed Configuration

## Issues Fixed

### 1. **Context Path Configuration**
- **Problem**: App was using `/ats` context path, but Railway expects root `/`
- **Fix**: Set `CONTEXT_PATH=""` environment variable to run at root path

### 2. **Security Configuration**
- **Problem**: Root path `/` and `/login` were not explicitly permitted
- **Fix**: Added `.antMatchers("/", "/login", "/error").permitAll()` in SecurityConfig

### 3. **Dockerfile Optimization**
- **Problem**: Maven wrapper issues in Docker build
- **Fix**: Use system Maven instead of wrapper for reliable builds

### 4. **Database Configuration (CRITICAL FIX)**
- **Problem**: Spring Boot 2.2.0 doesn't automatically parse Railway's `DATABASE_URL` format
- **Fix**: Created `DatabaseConfig.java` to manually parse `postgresql://user:pass@host:port/db` format
- **Details**: Railway provides `DATABASE_URL` as `postgresql://...` but Spring expects `jdbc:postgresql://...`

## Environment Variables for Railway

**CRITICAL**: Make sure you have a PostgreSQL service attached to your Railway project first!

Set these in your Railway service:

```
SPRING_PROFILES_ACTIVE=prod
CONTEXT_PATH=""
UPLOAD_PATH=/tmp/ats-uploads
```

Railway will automatically provide (when PostgreSQL service is attached):
- `DATABASE_URL` (in format: `postgresql://user:password@host:port/database`)
- `PORT`

**Important**: The `DATABASE_URL` is automatically injected by Railway when you add a PostgreSQL service to your project.

## Expected URLs

After deployment, your application will be accessible at:

- **Health Check**: `https://your-app.railway.app/health` (shows database connection status)
- **Login**: `https://your-app.railway.app/`
- **After login**: `https://your-app.railway.app/home/assignment`
- **Admin**: `https://your-app.railway.app/admin`
- **Recruitment**: `https://your-app.railway.app/recruitment`

## Test Accounts

Default credentials (defined in database-init.sql):
- **Admin**: `admin@spring.ats` / `Ats@ABC`
- **Recruiter**: `recruiter@spring.ats` / `Ats@ABC`

## Deployment Steps

1. **Add PostgreSQL Service FIRST** - In Railway dashboard, add PostgreSQL service to your project
2. **Push to Railway** - Railway will automatically detect the Dockerfile
3. **Configure Environment Variables** - Set the variables listed above
4. **Deploy** - Railway will build and deploy automatically

## Health Check

Railway will check `https://your-app.railway.app/health` for health status. This endpoint:
- Tests database connectivity
- Returns JSON with application and database status
- Returns HTTP 200 if healthy, HTTP 503 if database is down

## Latest Fixes (After Startup Failures)

### 5. **Application Startup Issues**
- **Problem**: App was failing to start, healthcheck failing with "service unavailable"
- **Fix**: Added comprehensive startup logging and error handling
- **Details**: 
  - Enhanced database connection error handling
  - Added detailed environment variable logging
  - Made health check more resilient (returns 200 even with DB issues)
  - Switched to `spring.jpa.hibernate.ddl-auto=update` for table creation

## Troubleshooting

### If Deployment Still Fails:

1. **Check Railway Application Logs** (not just build logs):
   - Go to Railway dashboard → Your service → Logs
   - Look for application startup messages starting with "=== Starting Spring ATS Application ==="
   - Check for database connection errors

2. **Verify PostgreSQL Service**:
   - Ensure PostgreSQL service is running in Railway
   - Check that `DATABASE_URL` environment variable is automatically set
   - Verify the database service is in the same project

3. **Check Environment Variables**:
   - `SPRING_PROFILES_ACTIVE=prod` (should be set)
   - `DATABASE_URL` (should be auto-generated by Railway)
   - Look for environment variable debug output in logs

4. **Test Health Endpoint**:
   - Visit `https://your-app.railway.app/health`
   - Should return JSON with application status even if database is down

### Expected Log Output:
```
=== Starting Spring ATS Application ===
Java Version: 11.x.x
Spring Profile: prod
Environment Variables:
  DATABASE_URL=postgresql://***:***@...
=== Configuring DataSource ===
=== Environment Variables Debug ===
DATABASE_URL=postgresql://***:***@...
=== End Debug ===
Using DATABASE_URL: postgresql://***:***@...
Parsed JDBC URL: jdbc:postgresql://...
=== DataSource Configuration Complete ===
```

If you don't see this output, the application isn't starting at all. Check for Java errors or missing dependencies in the logs.

The application should now deploy successfully on Railway!